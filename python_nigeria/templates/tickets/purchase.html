{% extends "apply.html" %} {% load static pinax_boxes_tags %} 
{% load static from staticfiles %} 
{% load pinax_boxes_tags %} 
{% block navigation %} 
{% endblock %} {% block head_title %} Purchase Ticket | 
{% endblock head_title %} 
{% block extra_stylings %} {{block.super}}
<style>
  @media (min-width: 992px) {
    #navbar.home+#header-section,
    #navbar.home+#speakers-section,
    #navbar.home+#purchase-tickets-section,
    #navbar.home+#code-of-conduct-section,
    #navbar.home+.custom-image-section {
      margin-top: -120px;
      padding-top: 80px;
      height: 500px !important;
    }
  }
  .hide-section{
    display: none !important;
  }
  .show-section{
    display: block;
  }
  .form-content p {
    margin-top: 0;
}
.coupon-code{
  display: flex;
}
.coupon-code button{
  padding: 0 30px !important;
  cursor: pointer;
}
.discount_value{
  display: flex;
 justify-content: space-between;
}
</style>
{% endblock extra_stylings %} {% block header-section %} {% comment %}
<div id="header-section" class="jumbotron jumbotron-fluid">
  {% box "home_introduction" %} {% endcomment %}
  <div id="purchase-tickets-section" class="ticket-section jumbotron jumbotron-fluid">
    <div class="container">
      <div class="row">
        <div class="col-md-5">
          <img class="logo" src="{% static 'designs/img/logo-light.svg' %}" />
          <div class="hide-mobile">
            <p>>>> Purchase Tickets</p>
            <h1 class="display-4">Python Conference 2018</h1>
            <p class="lead">
              September 15 — 17, 2018 08:00AM - O5:00PM Lagos, Nigeria
            </p>

          </div>
        </div>

        <div class="col-md-5 offset-md-2">
          <div class="form-content">
            <ul class="nav nav-tabs nav-justified" id="myTab" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" data-toggle="tab" href="#personal-info" role="tab" aria-selected="true">1. PERSONAL INFO</a>
              </li>
              <li class="nav-item">
                <a id="payment-link" class="nav-link" data-toggle="tab" href="#make-payment" role="tab" aria-selected="false">2. MAKE PAYMENT</a>
              </li>
            </ul>

            <div class="tab-content">
              <div class="tab-pane fade show active" id="personal-info" role="tabpanel">
                <div>
                  {% with user=request.user %}
                  <div id="error-section" class="hide-section alert alert-warning password-alert" role="alert">
                    Please ensure you fill out all the fields.
                  </div>
                  <div class="form-group">
                    <label for="first_name">pythonista.first_name</label>
                    <input type="text" class="form-control" id="first_name" value="{{user.first_name}}" placeholder="Enter your first name here"
                      required>
                  </div>
                  <div class="form-group">
                    <label for="last_name">pythonista.last_name</label>
                    <input type="text" value="{{user.last_name}}" class="form-control" id="last_name" placeholder="Enter your last name here"
                      required>
                  </div>
                  <div class="form-group">
                    <label for="email">pythonista.email</label>
                    <input type="text" class="form-control" value="{{user.email}}" id="email" placeholder="Enter your email address here" required>
                  </div>

                  {% endwith %} {% comment %}
                  <div class="alert alert-warning password-alert" role="alert">
                    By providing a password, you’ll get access to speaker keynotes and development resources.
                  </div>

                  <div class="form-group">
                    <label for="password">pythonista.password</label>
                    <input type="password" class="form-control" id="password" placeholder="Enter that hashed password here :-)" required>
                  </div> {% endcomment %}
                  <form>
                    <button id="toStep2" class="link-button btn btn-block btn-success">CONTINUE TO STEP 2.</a>
                    <script src="https://js.paystack.co/v1/inline.js"></script>
                  </form>
                  </div>
              </div>

              <div class="tab-pane fade" id="make-payment" role="tabpanel">
                <form>
                  <ul class="container">
                    {% for ticket in tickets %}
                    <li id="{{ticket.short_name}}" class="row ticket-select">
                      <div class="col-sm-9">
                        <p>{{ticket.name}}</p>
                        <span>N{{ticket.amount}}</span>
                      </div>
                      <div class="col-sm-3">
                        <select>
                          <option>0</option>
                          <option>1</option>
                          <option>2</option>
                          <option>3</option>
                          <option>4</option>
                          <option>5</option>
                        </select>
                      </div>
                    </li>

                    {% endfor %}
                  </ul>

                  <p id="initiate-discount">Have a discount code?
                    <a style="cursor: pointer;">Click here</a>
                  </p>
                  <div class="form-group discount_value hide-section">
                    <p>Discount</p>
                    <p ><span id="percent-value">0</span>%</p>
                  </div>
                <div class="form-group coupon-code hide-section">
                  <input type="text" class="form-control" id="coupon_value" value="" placeholder="Input coupon code" >
                  <button id="code_btn" class="btn btn-primary">Validate code</button>
                </div>

                  <button type="submit" id="pstackButton" disabled class="btn btn-block btn-success">CHECKOUT</button>

                  <div id="tickets-summary" class="row">
                    <p class="col-sm-12 col-md-4">QTY: <span id="ticket-count"></span></p>
                    <p class="col-sm -12 col-md-8 total-fee">TOTAL FEE: N<span id="total-fee">0</span></p>
                  </div>

                  <div id="tickets-payment-option" class="row">
                    <div class="col-sm-12 text-center">
                      Verve, MasterCard, Visa
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="copyright">
    <p class="text-center">COPYRIGHT 2017. PYCON NIGERIA 2018</p>
  </div>
  {% comment %}
  <div class="container-fluid">

  </div>
</div> {% endcomment %} {% endblock %} {% block content %} {% endblock %} {% block footer %} {% endblock %} {% block js_script %}
<script>
  let pricings = {}
  {% for ticket in tickets %}
  pricings["{{ticket.short_name}}"] = {{ticket.amount}}
  {% endfor %}
  function getNumberOfTickets(){
    let result = {}
    Object.keys(pricings).forEach(p=>{
      result[p] = document.querySelector(`li#${p} select`).value
    })
    return result
  }
  function determineTotal(){
  let prices = getNumberOfTickets()
      let total = 0
      let ticket_counts = 0
      Object.keys(prices).forEach(i=>{
        let prev = pricings[i]
          total += (parseInt(prev) * prices[i])
          ticket_counts += parseInt(prices[i])
      })
      let discount = document.querySelector("#percent-value").textContent
      let discountValue = total * parseInt(discount) / 100
      total = total - discountValue
      document.querySelector("#ticket-count").textContent = ticket_counts;
      document.querySelector("#total-fee").textContent = total.toLocaleString()
      if(total > 0){
        document.querySelector("#pstackButton").disabled = false
      }
      return total
  }
  getNumberOfTickets()
 document.querySelectorAll('li select').forEach(node=>{
   node.addEventListener("change",determineTotal)
 })
  var button = document.getElementById("toStep2")
  button.addEventListener("click",toNextStep)
 document.getElementById('pstackButton').addEventListener('click',payWithPaystack)
  function payWithPaystack(e){
    e.preventDefault()
    var handler = PaystackPop.setup({
      key: '{{public_key}}',
      email: 'customer@email.com',
      amount: 10000,
      ref: ''+Math.floor((Math.random() * 1000000000) + 1), // generates a pseudo-unique reference. Please replace with a reference you generated. Or remove the line entirely so our API will generate one for you
      metadata: {
         custom_fields: [
            {
                display_name: "Mobile Number",
                variable_name: "mobile_number",
                value: "+2348012345678"
            }
         ]
      },
      callback: function(response){
          alert('success. transaction ref is ' + response.reference);
      },
      onClose: function(){
          alert('window closed');
      }
    });
    handler.openIframe();
  }
  function toNextStep(e) {
    e.preventDefault()
    let first_name = document.querySelector('#first_name').value
    let last_name = document.querySelector('#last_name').value
    let email = document.querySelector('#email').value
    if (Boolean(first_name) && Boolean(last_name) && Boolean(email)) {
      displayError(false)
      document.querySelector('#payment-link').click()
    }else{
      displayError(true)
    }
  }
  function displayError(status){
let err = document.querySelector('#error-section') 
if(status){
  err.className = err.className.replace('hide-section',"")

}else{
 err.className = `${err.className.replace('hide-section',"")} hide-section`
}
  }
  function InitialDiscountLink(klass){
 let node = document.querySelector('#initiate-discount')
   node.className = klass 
  }
 document.querySelector('#initiate-discount').addEventListener("click",(e)=>{
   let coupon_section = document.querySelector('.coupon-code')
   coupon_section.className = coupon_section.className.replace("hide-section","")
   InitialDiscountLink("hide-section")
 })
 document.querySelector("#code_btn").addEventListener("click",e=>{
   e.preventDefault()
 let coupon_value = document.querySelector('#coupon_value').value
 validateCoupon(coupon_value,(data)=>{
   if(Boolean(data)){
     if(data.status > 0){
      let discountDisplay = document.querySelector(".discount_value")
      let coupon_section = document.querySelector('.coupon-code')
      coupon_section.className = `${coupon_section.className} hide-section`
      discountDisplay.className = discountDisplay.className.replace("hide-section","")
      document.querySelector("#percent-value").textContent = data.status
      determineTotal()
     }else{
      InitialDiscountLink("")
     }
   }
 })
 })
  function validateCoupon(value,callback){
    var xmlhttp = new XMLHttpRequest();
    var url = `{% url 'tickets:coupons' %}?value=${value}`;
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var myArr = JSON.parse(this.responseText);
            callback(myArr);
        }
    };
    xmlhttp.open("GET", url, true);
    xmlhttp.send();
  }
  function Ticketslug(callback){
    var xmlhttp = new XMLHttpRequest();

    var url = `{% url 'tickets:coupons' %}?value=${value}`;
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var myArr = JSON.parse(this.responseText);
            callback(myArr);
        }
    };
    xmlhttp.open("GET", url, true);
 xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
 xmlhttp.send(JSON.stringify({coupon:document.querySelector('#coupon_value').value,
tickets: getNumberOfTickets() }));
  }
</script>
{% endblock js_script %}
